<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinjaman Saya - Litera Akses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .hero-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        .slide-out-right {
            animation: slideOutRight 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navbar -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo & Brand -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <h1 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-700 to-blue-600 bg-clip-text text-transparent">
                        Litera Akses
                    </h1>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="/" class="px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        Beranda
                    </a>
                    <a href="/listbook" class="px-4 py-2 text-base font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all shadow-sm hover:shadow-md">
                        Daftar Buku
                    </a>
                </div>

                <!-- Hamburger Button (Mobile) -->
                <button id="hamburger-btn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </nav>
    </header>

    <!-- Mobile Sidebar Menu -->
    <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div id="mobile-menu" class="fixed top-0 right-0 bottom-0 w-64 bg-white shadow-2xl slide-in-right">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h2 class="text-lg font-bold text-gray-900">Menu</h2>
                <button id="close-menu-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <nav class="p-4 space-y-2">
                <a href="/" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Beranda</span>
                </a>
                <a href="/listbook" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <span>Daftar Buku</span>
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-gray-900">Litera Akses</p>
                        <p class="text-xs text-gray-600">Perpustakaan Digital</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="hero-gradient text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-5"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/10 backdrop-blur-sm rounded-2xl mb-4 sm:mb-6">
                <svg class="w-8 h-8 sm:w-10 sm:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-3 sm:mb-4">
                Pinjaman Buku Saya
            </h2>
            <p class="text-sm sm:text-base lg:text-lg opacity-95 max-w-2xl mx-auto">
                Pantau status peminjaman buku Anda dengan mudah. Masukkan email untuk melihat daftar buku yang Anda pinjam.
            </p>
        </div>
        <div class="absolute bottom-0 left-0 right-0">
            <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-8 sm:h-12">
                <path d="M0 80L60 73.3C120 66.7 240 53.3 360 46.7C480 40 600 40 720 43.3C840 46.7 960 53.3 1080 56.7C1200 60 1320 60 1380 60L1440 60V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0V80Z" fill="#f9fafb"/>
            </svg>
        </div>
    </section>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
        <!-- Search Form -->
        <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 sm:p-8 mb-8 sm:mb-10">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <h3 class="text-lg sm:text-xl font-bold text-gray-900">Cari Pinjaman Anda</h3>
            </div>
            <p class="text-sm sm:text-base text-gray-600 mb-6">
                Masukkan alamat email yang Anda gunakan saat meminjam buku
            </p>
            
            <form id="find-books-form" class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <input type="email" id="email" name="email" 
                    placeholder="contoh@email.com" 
                    required 
                    class="flex-grow px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm sm:text-base">
                <button type="submit" 
                    class="px-6 sm:px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all shadow-sm hover:shadow-md active:scale-95 text-sm sm:text-base whitespace-nowrap">
                    <span class="hidden sm:inline">Cari Pinjaman</span>
                    <span class="sm:hidden">Cari</span>
                </button>
            </form>
        </div>

        <!-- Book List Container -->
        <div id="book-list-container">
            <div class="text-center py-16 sm:py-20">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
                    <svg class="w-10 h-10 sm:w-12 sm:h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <p id="info-message" class="text-sm sm:text-base text-gray-600 font-medium">
                    Daftar buku yang Anda pinjam akan muncul di sini
                </p>
            </div>
        </div>
    </main>

    <!-- Token Modal -->
    <div id="token-modal" class="fixed inset-0 bg-black/60 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fadeIn">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 sm:px-8 py-5 rounded-t-2xl">
                <h3 class="text-xl sm:text-2xl font-bold text-white">Token Akses Buku</h3>
            </div>
            
            <!-- Modal Body -->
            <div class="px-6 sm:px-8 py-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <p class="text-sm text-gray-700">
                                <span class="font-medium text-gray-600">Buku:</span>
                                <span id="modal-book-title" class="font-semibold text-gray-900 block mt-1"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <form id="token-form" class="space-y-5">
                    <div>
                        <label for="token-input" class="block text-sm font-semibold text-gray-700 mb-2">
                            Kode Token <span class="text-red-500">*</span>
                        </label>
                        <textarea id="token-input" name="token" rows="4" required 
                            placeholder="Salin dan tempel kode token dari email Anda di sini..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none font-mono text-sm"></textarea>
                        <p class="text-xs text-gray-500 mt-2">
                            Kode token dikirimkan ke email Anda setelah peminjaman disetujui
                        </p>
                    </div>
                    
                    <div id="modal-message" class="text-sm font-medium rounded-lg p-3 hidden"></div>
                    
                    <div class="flex flex-col-reverse sm:flex-row gap-3 pt-2">
                        <button type="button" id="close-modal-btn" 
                            class="w-full sm:w-auto px-6 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-all border border-gray-300">
                            Batal
                        </button>
                        <button type="submit" id="submit-token-btn" 
                            class="w-full sm:w-auto px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg disabled:bg-blue-300 disabled:cursor-not-allowed">
                            Validasi & Baca Buku
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    const findBooksForm = document.getElementById('find-books-form');
    const bookListContainer = document.getElementById('book-list-container');
    const infoMessage = document.getElementById('info-message');
    const tokenModal = document.getElementById('token-modal');
    const tokenForm = document.getElementById('token-form');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalBookTitle = document.getElementById('modal-book-title');
    const tokenInput = document.getElementById('token-input');
    const modalMessage = document.getElementById('modal-message');

    // Mobile Menu
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
    const mobileMenu = document.getElementById('mobile-menu');
    const closeMenuBtn = document.getElementById('close-menu-btn');

    function openMobileMenu() {
        mobileMenuBackdrop.classList.remove('hidden');
        mobileMenu.classList.remove('slide-out-right');
        mobileMenu.classList.add('slide-in-right');
        document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
        mobileMenu.classList.remove('slide-in-right');
        mobileMenu.classList.add('slide-out-right');
        setTimeout(() => {
            mobileMenuBackdrop.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }, 300);
    }

    hamburgerBtn.addEventListener('click', openMobileMenu);
    closeMenuBtn.addEventListener('click', closeMobileMenu);
    mobileMenuBackdrop.addEventListener('click', (e) => {
        if (e.target === mobileMenuBackdrop) {
            closeMobileMenu();
        }
    });

    findBooksForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = e.target.email.value;
        
        bookListContainer.innerHTML = `
            <div class="text-center py-16">
                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">Mencari pinjaman Anda...</p>
            </div>
        `;

        try {
            const response = await fetch(`/api/my-books?email=${encodeURIComponent(email)}`);
            const books = await response.json();
            
            if (books.length === 0) {
                bookListContainer.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <p class="text-gray-500 font-medium mb-2">Tidak ada pinjaman ditemukan</p>
                        <p class="text-gray-400 text-sm">Pastikan email yang Anda masukkan sudah benar</p>
                    </div>
                `;
                return;
            }

            bookListContainer.innerHTML = '<div class="space-y-4"></div>';
            const container = bookListContainer.querySelector('.space-y-4');

            books.forEach(book => {
                const statusConfig = {
                    pending: { 
                        bg: 'bg-yellow-50', 
                        border: 'border-yellow-200',
                        text: 'text-yellow-700', 
                        dot: 'bg-yellow-500',
                        label: 'Menunggu Persetujuan',
                        icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                    },
                    approved: { 
                        bg: 'bg-green-50', 
                        border: 'border-green-200',
                        text: 'text-green-700', 
                        dot: 'bg-green-500',
                        label: 'Disetujui',
                        icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                    },
                    expired: { 
                        bg: 'bg-red-50', 
                        border: 'border-red-200',
                        text: 'text-red-700', 
                        dot: 'bg-red-500',
                        label: 'Kedaluwarsa',
                        icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                    },
                    rejected: { 
                        bg: 'bg-gray-50', 
                        border: 'border-gray-200',
                        text: 'text-gray-700', 
                        dot: 'bg-gray-500',
                        label: 'Ditolak',
                        icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                    }
                };
                
                const status = statusConfig[book.status] || statusConfig.rejected;
                const isApproved = book.status === 'approved';
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-lg transition-shadow';
                
                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row p-4 sm:p-5">
                        <div class="flex sm:block justify-center sm:justify-start mb-4 sm:mb-0">
                            <img src="${book.thumbnail_url || 'https://via.placeholder.com/120x160.png/EBF4FF/3B82F6?text=Cover'}" 
                                 alt="Cover ${book.title}" 
                                 class="w-24 h-32 sm:w-28 sm:h-36 object-cover rounded-lg shadow-sm">
                        </div>
                        
                        <div class="flex-grow sm:ml-5 flex flex-col">
                            <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-2 sm:mb-3 line-clamp-2">
                                ${book.title}
                            </h3>
                            
                            <div class="flex items-center space-x-2 mb-4">
                                <div class="flex items-center space-x-2 px-3 py-1.5 rounded-lg border ${status.border} ${status.bg}">
                                    <span class="w-2 h-2 rounded-full ${status.dot}"></span>
                                    <span class="text-xs sm:text-sm font-semibold ${status.text}">${status.label}</span>
                                </div>
                                <svg class="w-5 h-5 ${status.text}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${status.icon}
                                </svg>
                            </div>
                            
                            ${isApproved ? `
                                <button data-title="${book.title}" 
                                    class="open-token-modal-btn mt-auto w-full sm:w-auto px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-all shadow-sm hover:shadow-md active:scale-95 flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                    <span>Baca Buku</span>
                                </button>
                            ` : `
                                <button disabled 
                                    class="mt-auto w-full sm:w-auto px-5 py-2.5 bg-gray-100 text-gray-400 text-sm font-semibold rounded-lg cursor-not-allowed border border-gray-200 flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                    <span>Tidak Tersedia</span>
                                </button>
                            `}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            bookListContainer.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="text-red-600 font-medium mb-2">Gagal memuat daftar pinjaman</p>
                    <p class="text-gray-500 text-sm">Silakan coba lagi dalam beberapa saat</p>
                </div>
            `;
            console.error('Error fetching books:', error);
        }
    });

    function openModal(title) {
        modalBookTitle.textContent = `"${title}"`;
        tokenModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        tokenForm.reset();
        modalMessage.textContent = '';
        modalMessage.classList.add('hidden');
        modalMessage.className = 'text-sm font-medium rounded-lg p-3 hidden';
        tokenModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    bookListContainer.addEventListener('click', (e) => {
        if (e.target.closest('.open-token-modal-btn')) {
            const btn = e.target.closest('.open-token-modal-btn');
            openModal(btn.dataset.title);
        }
    });

    closeModalBtn.addEventListener('click', closeModal);
    tokenModal.addEventListener('click', e => {
        if (e.target === tokenModal) {
            closeModal();
        }
    });

    tokenForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const access_code = tokenInput.value.trim();
        const submitBtn = document.getElementById('submit-token-btn');
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Memvalidasi...';
        modalMessage.classList.remove('hidden');
        modalMessage.textContent = '';
        modalMessage.className = 'text-sm font-medium rounded-lg p-3';
        
        try {
            const response = await fetch('/api/get-read-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_code })
            });
            const result = await response.json();
            
            if (response.ok && result.success) {
                modalMessage.textContent = 'Token valid! Membuka buku...';
                modalMessage.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
                setTimeout(() => {
                    window.location.href = `/read?token=${result.token}`;
                }, 800);
            } else {
                throw new Error(result.error || 'Token tidak valid atau sudah kedaluwarsa.');
            }
        } catch (error) {
            modalMessage.textContent = error.message;
            modalMessage.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Validasi & Baca Buku';
        }
    });
</script>
</body>
</html>